{% extends "base_android.html" %}
{% load static %}
{% block content %}
{% include "templates.html" %}
<div class="container-fluid px-0 mx-0">
    <div class="cat_container row owl-carousel owl-theme w-100 px-0 mx-0">
    </div>

    <div class="row d-flex justify-content-end mx-0 mb-1" style="background-color: #222222;">
        <button class="btn btn-outline-light my-2 ml-3 text-light animated bounceInLeft" style="display:none" id="back">
            <i class="fa fa-caret-left my-1 mr-2"></i>Go Back
        </button>
        <div class="input-group my-2 col-5 animated bounceInRight" id="search_bar">
            <input type="text" class="form-control border text-light" style="background-color: #222222;" placeholder="Search" id="search_input">
            <div class="input-group-append">
                <button class="btn btn-outline-light" id="search_button" type="button" disabled><i class="fa fa-search"></i></button>
            </div>
        </div>
    </div>

    <div class="prod_filters my-0">
        <div id="accordion" role="tablist">
            <div class="card border-0">
              <div class="card-header py-2" role="tab" id="headingOne">
                <h5 class="mb-0">
                  <a class="collapsed" data-toggle="collapse" href="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                    <span class="text-dark h6">Filters</span>
                  </a>
                </h5>
              </div>
              <div id="collapseOne" class="collapse" role="tabpanel" aria-labelledby="headingOne">
                <div class="card-body py-1 px-2">
                    <div class="container-fluid p-0">
                    <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input" id="show_names" checked>
                        <label class="custom-control-label" for="show_names">Show product names</label>
                    </div>
                </div>
                </div>
              </div>
            </div>
          </div>
          
    </div>
    
    <div class="prod_container row mx-2 my-2">
    </div>

</div>



    <script>
    $(document).ready(function (){
        load_landing();
        const urlParams = new URLSearchParams(window.location.search);
        const myParam = urlParams.get('action');
        const pid =  urlParams.get('id');
        const cart = [];
        const transid_single = "";
        const trans_id = []
        const settings = {
            show_pn: true,
            };
        if(!window.localStorage.getItem('settings')){
        window.localStorage.setItem('settings', JSON.stringify(settings));
        }
        if (myParam=="load_product"){
            render_product_detail(pid);
        }
        if(!window.localStorage.getItem('cart')){
        window.localStorage.setItem('cart', JSON.stringify(cart));
        }
        if(!window.localStorage.getItem('transactions')){
        window.localStorage.setItem('transactions', JSON.stringify(trans_id));
        }
    });
    function load_category(category){
        if (category == undefined){
            $('.cat_container').show();
        }
        else{
        for (var i=0; i<cat_length; i++){
                    $('.cat_container').show()
                    if (category[i].image){
                    var t = document.querySelector('#cat_template');
                    t.content.querySelector('.cat_card').id = category[i].category_name;
                    t.content.querySelector('#pic').style = "background-image: url('" + category[i].image + "');width: 100%;padding-bottom: 100%;background-size: cover;background-position: center;";
                    t.content.querySelector('#cat_text').textContent = category[i].category_name;
                    var clone = document.importNode(t.content, true);
                    document.querySelector('.cat_container').appendChild(clone);
                    }
                }
        }
        $('.cat_container').owlCarousel({
            autoplay: true,
            autoplayTimeout: 2000,
            autoplayHoverPause: true,
            items: 3,
            loop: true,
            dots: false,
        });
    };

    function load_product(products){
        if (products == undefined){
            $('.prod_container').show();
        }
        else{
        $('.prod_container').show();
        for (var i=0; i<prod_length; i++){
                var t = document.querySelector('#prod_template');
                t.content.querySelector('.product_card').id = products[i].id;
                t.content.querySelector('#pic').style = "background-image: url('" + products[i].product_image + "');width: 100%;padding-bottom: 100%;background-size: cover;background-position: center;";
                t.content.querySelector('#product_text').textContent = products[i].product_name;
                var clone = document.importNode(t.content, true);
                document.querySelector('.prod_container').appendChild(clone);
            }
            $('.prod_container').hide();
            setTimeout(function(){
                $('.prod_container').show();
            }, 500);
        }
    }
    function load_remove_button(id){
        $('.remove_cart').remove();
        var t = document.querySelector('#remove_item_template');
        t.content.querySelector('.remove_cart').id = id;
        var clone = document.importNode(t.content, true);
        document.querySelector('#product_button').appendChild(clone);
    }

    function load_product_detail(product){
        $('.prod_filters').removeClass('animated bounceInLeft').hide();
        var t = document.querySelector('#prod_detail_template');
        t.content.querySelector('#det_pic').style = "background-image: url('" + product.product_image + "');width: 100%;padding-bottom: 100%;background-size: cover;background-position: center;";
        t.content.querySelector('#product_title').textContent = product.product_name;

        t.content.querySelector('#bt').setAttribute('data-id', product.product_image); 
        t.content.querySelector('#bt1').setAttribute('data-id', product.product_image1);
        t.content.querySelector('#bt2').setAttribute('data-id', product.product_image2);

        t.content.querySelector('#bt img').src = product.product_image; 
        t.content.querySelector('#bt1 img').src = product.product_image1;
        t.content.querySelector('#bt2 img').src = product.product_image2;

        t.content.querySelector('#product_cat').textContent = product.category;
        t.content.querySelector('.add_cart').id = product.id;
        t.content.querySelector('#product_price').textContent = "â‚±" + product.price;
        t.content.querySelector('#product_desc').textContent = product.description;
        var clone = document.importNode(t.content, true);
        if (!product.product_image1) clone.querySelector('#bt1').remove();
        if (!product.product_image2) clone.querySelector('#bt2').remove();
        x=t.content.querySelector('.qt_option');
        clone.querySelector('.qt_option').remove();
        if (product.stock != 0){
            clone.querySelector('#prod_out').remove();
        }
        else{
            clone.querySelector('#product_button').remove();
        }

        for (var i=0; (product.stock>i)&&(i!=10); i++){
            x.textContent = i+1;
            x.value = i+1;
            var option_clone = x.cloneNode(true);
            clone.querySelector('.quantity').append(option_clone);
        }
        var cart=JSON.parse(window.localStorage.getItem('cart'));
        document.querySelector('.prod_container').appendChild(clone);
        for (var i=0; i<cart.length; i++){
            if (product.id == cart[i].id){
                load_remove_button(product.id);
            }
        }
    }
    function search(search_value){
        $.ajax({
            url: "/new_api/api_products/?search=" + search_value,
            method: 'GET',
            dataType: 'json',
            success: function(data) {
                $('.prod_container').empty();
                $('#back').removeClass('animated bounceInLeft').addClass('animated bounceOutLeft');
                if (data.count > 0){
                prod_length = data.results.length;
                products = data.results;
                if (search_value != ""){
                    $('.prod_container').append("<div class='container-fluid text-center mb-2'><h5 class='animated bounceIn'>Showing (" + data.count + ") results for '" + search_value + "'.</h5></div>");
                }
                load_product(products);
                }
                else if (data.count == 0){
                    $('.prod_container').append("<div class='container-fluid text-center'><h5 class='animated bounceIn'>No results!</h5></div>");
                }
                }
            })
        }
    $('#search_input').keyup(function(){
    if ($('#search_input').val() == ""){
        $('#search_button').attr("disabled", true);
    }
    else{
        $('#search_button').attr("disabled", false);
    }
    });

    function filter_category(category){
        $('.prod_container').empty();
        $.ajax({
            url: "/new_api/api_products/?category__category_name=" + category,
            method: 'GET',
            dataType: 'json',
            success: function(data) {
                $('#back').removeClass('animated bounceInLeft').addClass('animated bounceOutLeft');
                if (data.count > 0){
                prod_length = data.results.length;
                products = data.results;
                $('.prod_container').append("<div class='container-fluid text-center mb-2'><h5 class='animated bounceIn'>" + category + "</h5></div>");
                load_product(products);
                check_show_names();
                $('.prod_filters').addClass('animated bounceInLeft').show();
                }
                else if (data.count == 0){
                    $('.prod_container').append("<div class='container-fluid text-center'><h5 class='animated bounceIn'>We have no more items in " + category + "</h5></div>");
                }
                }
            })
        }
        
    function load_landing() {
        render_products();
        render_category();
    }

    function render_products() {
        $.ajax({
            url: "/new_api/api_products/",
            method: 'GET',
            dataType: 'json',
            success: function(data) {
                $('#back').removeClass('animated bounceInLeft').addClass('animated bounceOutLeft').attr("disabled", true);
                $('.prod_container').empty();
                prod_length = data.results.length;
                products = data.results;
                load_product(products);
                check_show_names();
                $('.prod_filters').addClass('animated bounceInLeft').show();
            }
        });
    }

    function render_category() {
        $.ajax({
            url: "/new_api/api_category/",
            method: 'GET',
            dataType: 'json',
            success: function(data) {
                $('.cat_container').empty();
                cat_length = data.results.length;
                category = data.results;
                load_category(category);
            }
        });
    }

    function render_alert(product, quantity, status){
        $('html, body').animate({
        scrollTop: $("#pic").offset().top
        }, 250);
        $('.alert').remove(); 
        var t = document.querySelector('#alert_template');
        if (status == 'alert-success'){
            t.content.querySelector('#added').textContent = product + ' (' + quantity +') is succesfully added to your cart.'
        }
        else{
            t.content.querySelector('#added').textContent = product + ' is succesfully removed from your cart.'
        }
        var clone = document.importNode(t.content, true);
        clone.querySelector('.alert').classList.add(status);
        document.querySelector('.prod_container').prepend(clone);
    }

    function render_product_detail(id) {
        $.ajax({
            url: "/new_api/api_products/" + id,
            method: 'GET',
            dataType: 'json',
            success: function(data) {
                $('.prod_container').empty();
                $('#back').show().removeClass('animated bounceOutLeft').addClass('animated bounceInLeft').attr("disabled", false);
                load_product_detail(data);
            }
        });
    }

    $('#search_button').click(function(){
        var input = $('#search_input').val();
        search(input);
        }
    );
    $('#search_input').keypress(function(e){
        var input = $('#search_input').val();
        if (e.which == 13 ){
            search(input);
        }
    });
    //Click back button
    $('#back').click(function(){
        $('#search_input').val('');
        render_products();
    });
    //Click product card
    $(document).on('click', '.product_card', function() {
        prod_id = $(this).attr('id');
        render_product_detail(prod_id);
    });
    //Click category card
    $(document).on('click', '.cat_card', function() {
        id = $(this).attr('id');
        filter_category(id);
    });
    //Change images of product detail
    $(document).on('click','.img_bt', function(){
        $('#det_pic').css({"backgroundImage": "url("+ $(this).data('id') +")"});
      })
    //add to cart --> store in localStorage
    $(document).on('click', '.add_cart', function(){
        var qty = $('.quantity').val();
        var prd_id = $('.add_cart').attr('id');
        var cart = [];
        const product = {
            id: prd_id,
            quantity: qty,
            };
        cart.push(product);

        var cart_old=JSON.parse(window.localStorage.getItem('cart'));
        for(var i=0; cart_old.length>i; i++){
            if (cart_old[i].id == product.id){
                cart_old.splice(i,1);
            }
        }
        cart_old.push(product);
        window.localStorage.setItem('cart', JSON.stringify(cart_old));
        render_alert($('#product_title').html(), qty,'alert-success');
        load_remove_button(prd_id);

    });
    $(document).on('click', '.remove_cart', function(){
        var prd_id = $('.remove_cart').attr('id');
        var cart=JSON.parse(window.localStorage.getItem('cart'));

        for (var i=0; i<cart.length; i++){
            if (cart[i].id == prd_id){
                cart.splice(i,1);
                window.localStorage.setItem('cart', JSON.stringify(cart));
                $('.remove_cart').remove();
                $('html, body').animate({
                scrollTop: $("#pic").offset().top
                }, 250);
                render_alert($('#product_title').html(), 0, 'alert-danger')
            }
        }
    });
    function check_show_names(){    
        const show=JSON.parse(window.localStorage.getItem('settings')).show_pn;
        if (show == true){
            $('.prod_name').addClass('animated bounceIn').show();
            $('#show_names').prop("checked", show);
            }
        else if (show == false){
            $('.prod_name').removeClass('animated bounceIn').hide();
            $('#show_names').prop("checked", show);
        }
        
    }

    $(document).on('change', '#show_names' ,function(){
        const show = $('#show_names').prop("checked");
        var settings=JSON.parse(window.localStorage.getItem('settings'));
        settings.show_pn = show;
        window.localStorage.setItem('settings', JSON.stringify(settings));
        check_show_names(); 
    });
    </script>
    
{% endblock content %}