{% extends "base_android.html" %}
{% load static %}
{% block content %}
{% include "modal.html" %}
{% include "templates.html" %}
<div class="row d-flex justify-content-end mx-0 mb-4 pr-3" id="bar" style="background-color: #222222;">
    <button class="btn btn-outline-light my-2 ml-3 text-light animated bounceInLeft" onclick="window.history.back();" id="back">
        <i class="fa fa-caret-left my-1 mr-2"></i>Go Back
    </button>
</div>
<div class="container-fluid cart_cont">
    <p class="h3"><i class="fa fa-shopping-cart mr-2"></i>Your Cart</p>
    <span class="font-italic">Note: Delivery time might vary on different locations.</span>
    <span class="font-italic">Total Price includes delivery fee.</span>
    <table id="cart_table" class="table table-striped table-bordered">
        <thead>
            <th class="py-0 px-1">Product</th>
            <th class="p-0 text-center">Qty</th>
            <th class="p-0 text-center">Price</th>
            <th class="p-0 text-center">Delivery</th>
            <th class="p-0 text-center">Total Price</th>
        </thead>
        <tbody id="cart_table_body" class="table-body">
        </tbody>
    </table>
    <div class="container-fluid p-0">
    <button type="button" data-id="{% url 'an_order_form' %}" class="action btn btn-outline-dark rounded-0 float-right">Checkout</button>
    <button type="button" class="btn btn-outline-danger rounded-0 float-right mr-1">Empty Cart</button>
    </div>
</div>
<script>
    $(".action").each(function() {
        $(this).modalForm({
            formURL: $(this).data('id')
        });
    });

    var cart = JSON.parse(window.localStorage.getItem('cart'));
    if (cart.length){
    var gt=0;
    for (var i=0; cart.length>i; i++){
    $.ajax({
            url: "/new_api/api_products/" + cart[i].id,
            method: 'GET',
            dataType: 'json',
            async: false,
            success: function(data) {
                for (var x=0; cart.length>x; x++){
                    if (cart[x].id == data.id){
                        load_to_table(data, cart[x]);
                        gt += ((parseFloat(data.price)+parseFloat(data.delivery_price))*cart[x].quantity);
                    }
                }
            }
        });
    }
    add_gt(gt.toFixed(2));
    }
    else{
        $('.cart_cont').empty();
        var t = document.querySelector('#empty_cart_template');
        var clone = document.importNode(t.content, true);
        document.querySelector('.cart_cont').appendChild(clone);
    }

    function add_gt(grand_total){
        var t = document.querySelector('#gt_template');
        t.content.querySelector('#gt').textContent = '₱' +grand_total;
        var clone = document.importNode(t.content, true);
        document.querySelector('#cart_table_body').appendChild(clone);
    }

    function load_to_table(product, cart){
        var t = document.querySelector('#cart_row_template');
        t.content.querySelector('#prod_name').textContent = product.product_name;
        t.content.querySelector('#prod_name').setAttribute('data-id', product.id);
        t.content.querySelector('#prod_quantity').textContent = cart.quantity;
        t.content.querySelector('#prod_price').textContent = '₱' + product.price;
        t.content.querySelector('#del_price').textContent = '₱' + product.delivery_price;
        t.content.querySelector('#total_price').textContent = '₱' + ((parseFloat(product.price)+parseFloat(product.delivery_price))*cart.quantity).toFixed(2);
        var clone = document.importNode(t.content, true);
        document.querySelector('#cart_table_body').appendChild(clone);
    }

    $(document).on('click', '.product', function(){
        const id = $(this).attr("data-id");
        window.location = {% url 'an_landing' %}+'?action=load_product&id=' + id;
    });
</script>
{% endblock content %}