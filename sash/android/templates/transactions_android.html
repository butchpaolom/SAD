{% extends "base_android.html" %}
{% block content %}
{% include "modal.html" %}
{% include "templates.html" %}
<div class="row d-flex justify-content-end mx-0 mb-4 pr-3 cscheme" id="bar" style="background-color: #222222;">
    <button class="btn btn-outline-light my-2 ml-3 text-light animated bounceInLeft" onclick="window.history.back();" id="back">
        <i class="fa fa-caret-left my-1 mr-2"></i>Go Back
    </button>
</div>
<div class="container-fluid trans_cont">
    <p class="h4">Transactions</p>
    <span>Here are your current Transactions.</span><br>
    <span>Please consider at least 5 minutes after paying using PayPal to reflect.</span>
</div>
<script>
    const transacs = JSON.parse(window.localStorage.getItem('transactions'));
    if(!transacs.length){
        $('.trans_cont').empty();
        var t = document.querySelector('#empty_trans_template');
        var clone = document.importNode(t.content, true);
        document.querySelector('.trans_cont').appendChild(clone);
    }
    for (var i=0; transacs.length>i; i++)
    {
     $.ajax({
            url: "/new_api/api_transaction/" + transacs[i],
            method: 'GET',
            dataType: 'json',
            success: function(data) {
                render_transaction(data);
                }
            });
    }
    function render_transaction(data){
        var t = document.querySelector('#trans_template');
        if (data.final_order.payment_method == 'PayPal'){
            t.content.querySelector('#pm').setAttribute('data-id', data.final_order.trans_id); 
        }
        t.content.querySelector('#ref').href = '#x' + data.id;
        t.content.querySelector('#ref').textContent = data.final_order.trans_id;
        t.content.querySelector('#ref').setAttribute('aria-controls', 'x' + data.id);
        t.content.querySelector('.hed').id = 'x' + data.id;
        t.content.querySelector('#trans_id').textContent = data.final_order.trans_id;
        t.content.querySelector('#status').textContent = data.status;
        t.content.querySelector('#pm').textContent = data.final_order.payment_method;
        t.content.querySelector('#pm').setAttribute('data-id', "{% url 'payment_process' %}" + '?trans_id=' + data.final_order.trans_id);
        t.content.querySelector('#gtotal').textContent = '₱' + data.final_order.overall_price;
        var clone = document.importNode(t.content, true);
        if (!data.paid){
            clone.querySelector('#paid').remove();
        }
        var prod = t.content.querySelector('#trans_products').querySelector('#p_row');
        clone.querySelector('#trans_products').querySelector('#p_row').remove();
        for (var i=0; data.final_order.orders.length>i; i++){
            prod.querySelector('#p_name').textContent = data.final_order.orders[i].product;
            prod.querySelector('#p_qty').textContent = data.final_order.orders[i].quantity;
            prod.querySelector('#p_del').textContent = '₱' + data.final_order.orders[i].delivery;
            prod.querySelector('#p_price').textContent = '₱' + data.final_order.orders[i].product_price;
            prod.querySelector('#p_tprice').textContent = '₱' + data.final_order.orders[i].total_price;
            var prod_clone = prod.cloneNode(true);
            clone.querySelector('#trans_products').append(prod_clone);
        }
        document.querySelector('.trans_cont').appendChild(clone);
    }
    $(document).on('click', '#pm', function(){
        if (this.textContent == 'PayPal'){
            window.location = $(this).data('id');
        }
    });
</script>
{% endblock content %}